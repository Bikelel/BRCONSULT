<?xml version="1.0" encoding="utf-8"?>

<odoo>
    <template id="report_prestation_document">
        <t t-call="web.external_layout">
            <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)" />
            <!--   HEADER           -->
            <div>
                <t t-set="report_name_brconsult" t-value='doc.name'/>
                <t t-set="partner_id_name_brconsult" t-value='doc.partner_id.name' t-if='doc.partner_id'/>
                <t t-set="site_address_brconsult" t-value='doc.site_address' t-if='doc.site_address'/>
                
                <div class='row'>
                    <div class='col-2'>
                        <img t-if="doc.company_id.logo" t-att-src="image_data_uri(doc.company_id.logo)" style="max-height: 130px;"/>
                    </div>
                    <div class='col-10 text-center' style="border-radius:10px;border: 3px solid black; background-color:#D3D3D3; min-height:130px; max-height: 130px;">
                        <div style="color:#5F5F5F;font-weight:bold;font-size:16px;"> <span>RAPPORT D’INSPECTION</span></div>
                        <div style="color:#C00000;font-weight:bold;font-size:20px;"><span t-esc="doc.title_label"/></div>
                        <div style="color:#5F5F5F;font-weight:bold;font-size:16px;">
                            <span>Type de mission :</span>
                            <span t-field="doc.verification_type" />
                        </div>
                        <div>
                            <span t-field="doc.message_label" style="color:#5F5F5F;font-weight:bold; font-size:12px;"/>
                        </div>
                    </div>
                </div>
            </div>
            <!--   Body   -->
            <div style="margin-top: 20px; font-size:14px;" class="page">
                <div class="oe_structure"/>
                <style>
                    .bloc_title {
                    border: 3px solid #5F5F5F;
                    padding: 20px;
                    background-color: #D8D8D8;
                    border-radius: 10px;
                    margin-bottom: 10px;
                    margin-top: 50px;
                    page-break-inside:avoid;
                    }
                    .bloc_sub_title {
                    
                    padding: 20px;
                    background-color: #F1F1F1;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    margin-top: 20px;
                    page-break-inside:avoid;
                    }
                    .bloc_sub_title2 {
                    padding: 10px;
                    background-color: #F3F3F3;
                    border-radius: 5px;
                    margin-bottom: 10px;
                    margin-top: 10px;
                    page-break-inside:avoid;
                    }
                    table {
                    margin-top: 15px;
                    border: 2px solid #5F5F5F;
                    width: 100%;
                    }
                    
                    table tr td{
                    padding: 10px;
                    border: 2px solid #5F5F5F;
                    }
                    table tr th{
                    padding: 10px;
                    border: 2px solid #5F5F5F;
                    }

                    ul{
                    margin-left:20px;
                    }
                    ol{
                    margin-left:9px;
                    }
                    .inspector_user{
                      text-transform: capitalize;
                    }
                    .borderless {
                        border-top: none;
                        border-left: none;
                        border-right: none;
                        border-bottom: none;
                    }


                </style>
                <div class="row" style="font-size:12px; margin-bottom:50px;">
                    <div class='col-9'>
                        <t t-if="doc.name">
                            <span> N° Rapport: </span>
                            <span t-field="doc.name"/>
                        </t>
                    </div>
                    <div class='col-3' style="margin-left:40px;">
                        <t t-if="doc.date">
                            <span> Fait à </span>
                            <span t-field="doc.company_id.city" />, <br/>
                            Le <span t-field="doc.date"/>
                        </t>
                    </div>
                </div>
                <table class="table">
                    <tbody>
                        <tr>
                            <td style="width: 50%;">
                                Entreprise : <span t-field="doc.partner_id"/>
                            </td>
                            <td style="width: 50%;">
                                Date et heure de vérification : <span t-field="doc.verification_date"/>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Représenté par : <span t-field="doc.partner_contact"/>
                            </td>
                            <td>
                                Vérificateur : <span t-field="doc.user_id"/>
                            </td>
                        </tr>
                        <tr>
                            <td >
                                Adresse du chantier : <span t-field="doc.site_address"/><br/>
                                Localisation : <span t-field="doc.site_localisation"/>
                            </td>
                            <td>
                                Nom de la personne présente lors de notre intervention : <span t-field="doc.prensent_contact"/><br/>
                                Surface d’échafaudage annoncée (en m²) : <span t-field="doc.scaffolding_surface"/><br/>
                                Surface d’échafaudage inspectée (en m²) = <span t-field="doc.inspected_scaffolding_surface"/>

                            </td>
                        </tr>
                    </tbody>
                </table>

                <div name="conformite_installation" class="text-center" style="margin-top:50px;" t-if="doc.report_parameter_id and doc.report_parameter_id.installation_compliance">
                    <div style="font-weight:bold;font-size:16px;">CONFORMITE DE L’INSTALLATION</div>
                    <div>
                       <span t-field="doc.report_parameter_id.installation_compliance" />
                    </div>
                </div>
                <div name="opinion" style="margin-top:30px;">
                    <table name="opinion" style="margin-top:30px; min-height:250px; max-height: 250px;" class='table text-center'>
                        <tbody>
                            <tr>
                                <td style="width: 50%; border: none; padding-top:40px;padding-bottom:40px;" >
                                    <input type="checkbox" t-att-checked="'checked' if doc.favorable_opinion else None"/> AVIS FAVORABLE
                                </td>
                                <td style="width: 50%; border: none; padding-top:40px; padding-bottom:40px;">
                                    <div style="margin-bottom:20px;">
                                        <input type="checkbox" t-att-checked="'checked' if doc.opinion_with_observation else None"/> Avec observation(s)
                                    </div>
                                    <div t-if="doc.opinion_with_observation">
                                    Levée d’observations recommandée
                                    </div>
                                    <div style="margin-bottom:20px;">
                                        <input type="checkbox" t-att-checked="'checked' if doc.defavorable_opinion else None"/> AVIS DEFAVORABLE
                                    </div>
                                    <div t-if="doc.defavorable_opinion">
                                    Levée de reserves recommandée
                                    </div>
                                </td>
                            </tr>
                        </tbody>

                    </table>
                </div>
                <div name="visa" style="margin-top:50px; min-height:300px; max-height: 300px; border: 2px solid #5F5F5F;">
                    <div class='row'>
                        <div class='col-7' style="padding:20px;">
                            Commentaires:<br/>
                            <span t-field="doc.comment_observation_fiche"/>
                        </div>
                        <div class='col-5 text-center' style="padding:20px;">
                            
                            <img t-if="doc.user_id.visa_user" t-att-src="image_data_uri(doc.user_id.visa_user)" style="max-height: 270px;"/>
                            
                        </div>
                    </div>
                </div>
                <div style="page-break-after: always;"/>
                <div class="bloc_title">
                    1) Périmètre de la mission
                </div>
                <div style="margin-top:30px;">
                
La présente mission est réalisée conformément au contrat référencé
                    <span t-field="doc.contrat_ref"/>
 Il s’agit d’une mission de <span t-field="doc.verification_type"/> (automatiquement) limitée à la vérification visuelle des zones de l’échafaudage accessibles en sécurité. <br/>
                    
                    <span t-field="doc.report_parameter_id.scope_mission" t-if="doc.report_parameter_id and doc.report_parameter_id.scope_mission"/>
                    
                </div>
                <div class="bloc_title">
                    2) Localisation, schéma et photographies de l’échafaudage
                </div>
                <div style="margin-top:30px;" t-if="doc.location_diagram">
                    <div class="bloc_sub_title2">
                    Schéma
                    </div>
                    <img t-if="doc.location_diagram" t-att-src="image_data_uri(doc.location_diagram)" style="max-height: 350px;"  class='text-center'/>
                </div>
                <div style="margin-top:30px;" t-if="doc.image_ids">
                    <div class="bloc_sub_title2">
                    Photos
                    </div>
                    
                    <t t-foreach="doc.image_ids" t-as="image">
                        <div class='text-center col-12 row' style="page-break-inside:avoid;">
                            <div style="padding:15px;" class="col-6" t-if="image">
                                <img t-if="image.image" t-att-src="image_data_uri(image.image)" style="max-height: 300px;"/>
                            </div>
                            <div style="padding:15px;" class="col-6" t-if="image">
                                <img t-if="image.image" t-att-src="image_data_uri(image.image)" style="max-height: 300px;"/>

                            </div>
                        </div>
                    </t>
                    
                </div>
                <div class="bloc_title">
                    3) Caractéristiques de l’échafaudage
                </div>
                <table class='table' style="margin-top:30px;">
                    <tr>
                        <td>Marque</td>
                        <td>Type</td>
                        <td>Hauteur de 1er Niveau</td>
                        <td>Hauteur maxi (en m)</td>
                        <td>Linéaire (en m)</td>
                        <td>Surface inspectée (en m2)</td>
                    </tr>
                    <tbody>
                        <t t-foreach="doc.scaffolding_mark_ids" t-as="mark">
                            <tr>
                                <td><span t-field="mark.mark_id"/></td>
                                <td><span t-field="mark.type"/></td>
                                <td><span t-field="mark.height"/></td>
                                <td><span t-field="mark.height_max"/></td>
                                <td><span t-field="mark.linear"/></td>
                                <td><span t-field="mark.inspected_surface"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <table class='table' style="margin-top:30px;">
                    <tr>
                        <td>Caractéristiques</td>
                        <td>Présence</td>
                        <td>HLongueur</td>
                        <td>Largeur</td>
                        <td>Hauteur</td>
                        <td>Surface</td>
                        <td>Localisation </td>
                    </tr>
                    <tbody>
                        <t t-foreach="doc.scaffolding_characteristic_ids" t-as="charac">
                            <tr>
                                <td><span t-field="charac.characteristic_id"/></td>
                                <td><span t-field="charac.is_presence"/></td>
                                <td><span t-field="charac.length"/></td>
                                <td><span t-field="charac.width"/></td>
                                <td><span t-field="charac.height"/></td>
                                <td><span t-field="charac.surface"/></td>
                                <td><span t-field="charac.localisation_id"/></td>
                                
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div style="border: 2px solid #5F5F5F; padding:10px">
                    Commentaires:<br/>
                    <span t-field="doc.comment_scaffolding_characteristic"/>
                </div>
                <div class="bloc_title">
                    4) Examens
                </div>
                <div class="bloc_sub_title">
                    4.1) Examen d’adéquation
                </div>
                <div t-if="doc.report_parameter_id and doc.report_parameter_id.adequation_exam">
                    <span t-field="doc.report_parameter_id.adequation_exam"/>
                </div>
                <div class="bloc_sub_title2">
                   • Nature des travaux :
                </div>
                <table class='table' style="margin-top:20px;">
                    <tr>
                        <td>Marque</td>
                        <td>Type</td>
                        <td>Hauteur de 1er Niveau</td>
                    </tr>
                    <tbody>
                        <t t-foreach="doc.adequacy_exam_ids" t-as="exam">
                            <tr>
                                <td><span t-field="exam.works_nature_id"/></td>
                                <td><span t-field="exam.precision"/></td>
                                <td><span t-field="exam.is_examined"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div class="bloc_sub_title2">
                   • Dispositif de protection :
                </div>
                <table class='borderless'>
                    <tr class='borderless'>
                        <td style="width:35%;" class='borderless'>Présence d'un pare-gravats:</td>
                        <td class='borderless'><span t-field="doc.is_pare_gravats"/></td>
                    </tr>
                    <tr class='borderless'>
                        <td class='borderless'>Présence d'un autre dispositif:</td>
                        <td class='borderless'><span t-field="doc.is_other_device"/></td>
                    </tr>
                    <tr t-if="doc.other_device_id" class='borderless'>
                        <td class='borderless'>Autre dispositif:</td>
                        <td class='borderless'><span t-field="doc.other_device_id"/></td>
                    </tr>
                   
                </table>
                
                <div class="bloc_sub_title2">
                   • Charges d’exploitation de l’échafaudage par défaut:
                </div>
                <table class='table' style="margin-top:20px;">
                    <tr>
                        <td>Classe de l’échafaudage</td>
                        <td>Surcharge d’exploitation (en kg/m2)</td>
                        <td>Précision</td>
                    </tr>
                    <tbody>
                        <t t-foreach="doc.scaffolding_operating_load_ids" t-as="classe">
                            <tr>
                                <td><span t-field="classe.scaffolding_class_id"/></td>
                                <td><span t-field="classe.operating_overload"/></td>
                                <td><span t-field="classe.precision"/></td>
                                
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div class="bloc_sub_title2">
                   • Constat(s):
                </div>
                <table class='table' style="margin-top:20px;">
                    <tr>
                        <td>Points de vérification</td>
                        <td>Observations/Réserves </td>
                        <td>Précisions </td>
                        <td class="text-center">Photos </td>
                        <td>Statut </td>
                        <td>Date </td>
                    </tr>
                    <tbody>
                        <t t-foreach="doc.constat_adequacy_exam_ids" t-as="constat">
                            <tr>
                                <td ><span t-field="constat.verification_point_id"/></td>
                                <td>
                                    <ol>
                                        <t t-foreach="constat.observation_ids" t-as="observation">
                                            <li><span t-field="observation.name"/></li>
                                        </t>
                                    </ol>
                                </td>
                                <td><span t-field="constat.precision"/></td>
                                <td style="width: 310px;" class="text-center"><img t-if="constat.photo" t-att-src="image_data_uri(constat.photo)" style="max-width: 300px;"/>
                                    </td>
                                <td><span t-field="constat.state"/></td>
                                <td><span t-field="constat.date"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                
                <div class="bloc_sub_title">
                    4.2) Examen de montage et d'installation
                </div>
                <div>
                Art. 3 – II- « L’examen de l’état de montage et d’installation d’un échafaudage » consiste à s’assurer qu’il est monté et installé de façon sûre, conformément à la notice d’instructions du fabricant ou, lorsque la configuration de montage ne correspond pas à un montage prévu dans la notice, en tenant compte de la note de calcul et conformément au plan de montage établi par une personne compétente »
(Arrêté du 21 Décembre 2004).
                </div>
                <table class='borderless'>
                    <tr class='borderless'>
                        <td class='borderless' style="width:35%;">Présentation de registre de sécurité:</td>
                        <td class='borderless'><span t-field="doc.security_register"/></td>
                    </tr>
                    <tr class='borderless'>
                        <td class='borderless'>Mise à disposition du dossier de montage:</td>
                        <td class='borderless'><span t-field="doc.assembly_file"/></td>
                    </tr>
                </table>
 
                <table t-if="doc.assembly_file=='yes'" class="table">
                    <tr class="text-center">
                        
                        <td>Plans d’exécution (PE)</td>
                        <td>Note de calcul</td>
                    </tr>
                    <tbody>
                        <tbody>
                            <tr class="text-center">
                                
                                <td><input type="checkbox" t-att-checked="'checked' if doc.execution_plan else None"/></td>
                                <td><input type="checkbox" t-att-checked="'checked' if doc.calculation_notice else None"/></td>
                            </tr>
                        </tbody>
                    </tbody>
                </table>
                
                <table class='borderless'>
                    <tr class='borderless'>
                        <td class='borderless' style="width:35%;">Mise à disposition du dossier de montage:</td>
                        <td class='borderless'>
                            <ul>
                                <t t-foreach="doc.soil_support_data_ids" t-as="soil">
                                    <li><span t-field="soil.name"/></li>
                                </t>
                            </ul>
                        </td>
                    </tr>
                    <tr class='borderless'>
                        <td class='borderless'>Nature du sol/support d’implantation:</td>
                        <td class='borderless'>
                            <ul>
                                <t t-foreach="doc.anchor_support_data_ids" t-as="anchor">
                                    <li><span t-field="anchor.name"/></li>
                                </t>
                            </ul>
                        </td>
                    </tr>
                </table>
                <div class="bloc_sub_title">
                   • Données aux ancrages:
                </div>
                <table class='borderless'>
                    <tr class='borderless'>
                        <td class='borderless' style="width:35%;">Type d'ancrage:</td>
                        <td class='borderless'><span t-field="doc.anchor_type_id"/></td>
                    </tr>
                    <tr class='borderless' t-if="doc.anchor_type_id and doc.anchor_type_id.id==1">
                        <td class='borderless' style="width:35%;">Type de chevilles:</td>
                        <td class='borderless'><span t-field="doc.ankles_type"/></td>
                    </tr>
                    <tr class='borderless'>
                        <td class='borderless' style="width:35%;">Nombre constaté:</td>
                        <td class='borderless'><span t-field="doc.anchor_data_number"/></td>
                    </tr>
                    <tr class='borderless'>
                        <td class='borderless' style="width:35%;">Nombre théorique requis:</td>
                        <td class='borderless'><span t-field="doc.anchor_data_theoretical_number"/></td>
                    </tr>
                    <tr class='borderless'>
                        <td class='borderless' style="width:35%;">Différence:</td>
                        <td class='borderless'><span t-field="doc.anchor_data_difference_number"/></td>
                    </tr>
                    <tr class='borderless'>
                        <td class='borderless' style="width:35%;">Données relatives aux réactions d'appuis au sol ou au support d’accueil:</td>
                        <td class='borderless'><span t-field="doc.ground_support_data"/></td>
                    </tr>
                    <tr class='borderless'>
                        <td class='borderless' style="width:35%;">Données relatives aux charges climatiques:</td>
                        <td class='borderless'><span t-field="doc.climatic_data"/></td>
                    </tr>
                    <tr class='borderless'>
                        <td class='borderless' style="width:35%;">Données relatives à la nature du bâchage éventuel:</td>
                        <td class='borderless'><span t-field="doc.covering_nature_data"/></td>
                    </tr>
                </table>
   

                <div class="bloc_sub_title">
                   • Constat(s):
                </div>
                
                <table class='table' style="margin-top:20px;">
                    <tr>
                        <td>Points de vérification</td>
                        <td>Observations/Réserves </td>
                        <td>Précisions </td>
                        <td class="text-center">Photos </td>
                        <td>Statut </td>
                        <td>Date </td>
                    </tr>
                    <tbody>
                        <t t-foreach="doc.constat_assembly_exam_ids" t-as="constat">
                            <tr>
                                <td ><span t-field="constat.verification_point_id"/></td>
                                <td>
                                    <ol>
                                        <t t-foreach="constat.observation_ids" t-as="observation">
                                            <li><span t-field="observation.name"/></li>
                                        </t>
                                    </ol>
                                </td>
                                <td><span t-field="constat.precision"/></td>
                                <td style="width: 40%;" class="text-center"><img t-if="constat.photo" t-att-src="image_data_uri(constat.photo)" style="max-width: 160px;"/>
                                    </td>
                                <td><span t-field="constat.state"/></td>
                                <td><span t-field="constat.date"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div class="bloc_sub_title">
                   • Examen de l'etat de conservation:
                </div>
                <table class='table' style="margin-top:20px;">
                    <tr>
                        <td style="width: 80%;">La présence et la bonne installation des dispositifs de protection collective et des moyens d'accès</td>
                        <td><span t-field="doc.presence_correct_installation"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">L'absence de déformation permanente ou de corrosion des éléments constitutifs de l'échafaudage pouvant compromettre sa solidité</td>
                        <td><span t-field="doc.permanent_deformation_absence"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">La présence de tous les éléments de fixation ou de liaison des constituants de l'échafaudage</td>
                        <td><span t-field="doc.presence_fixing"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">L'absence de jeu décelable susceptible d'affecter ces éléments</td>
                        <td><span t-field="doc.absence_detectable_play"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">La bonne tenue des éléments d'amarrage (ancrage, vérinage)</td>
                        <td><span t-field="doc.good_behavior"/></td>
                    </tr>
                     <tr>
                        <td style="width: 80%;">L'absence de désordre au niveau des appuis et des surfaces portantes</td>
                        <td><span t-field="doc.absence_disorder"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">La présence de tous les éléments de calage et de stabilisation ou d'immobilisation</td>
                        <td><span t-field="doc.presence_wedging"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">La bonne fixation des filets et des bâches sur l'échafaudage, ainsi que la continuité du bâchage sur toute la surface extérieure</td>
                        <td><span t-field="doc.good_fixing"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">Le maintien de la continuité, de la planéité, de l'horizontalité et de la bonne tenue de chaque niveau de plancher</td>
                        <td><span t-field="doc.maintaining_continuity"/></td>
                    </tr>
                     <tr>
                        <td style="width: 80%;">La visibilité des indications sur l'échafaudage relatives aux charges admissibles</td>
                        <td><span t-field="doc.visibility_indications"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">L'absence de charges dépassant ces limites admissibles</td>
                        <td><span t-field="doc.absence_loads_exceeding"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">L'absence d'encombrement des planchers</td>
                        <td><span t-field="doc.lack_floor_space"/></td>
                    </tr>
                </table>
                <div class="bloc_sub_title">
                   • Constat(s):
                </div>
                <table class='table' style="margin-top:20px;">
                    <tr>
                        <td>Points de vérification</td>
                        <td>Observations/Réserves </td>
                        <td>Précisions </td>
                        <td class="text-center">Photos </td>
                        <td>Statut </td>
                        <td>Date </td>
                    </tr>
                    <tbody>
                        <t t-foreach="doc.constat_conservation_state_exam_ids" t-as="constat">
                            <tr>
                                <td ><span t-field="constat.verification_point_id"/></td>
                                <td>
                                    <ol>
                                        <t t-foreach="constat.observation_ids" t-as="observation">
                                            <li><span t-field="observation.name"/></li>
                                        </t>
                                    </ol>
                                </td>
                                <td><span t-field="constat.precision"/></td>
                                <td style="width: 40%;" class="text-center"><img t-if="constat.photo" t-att-src="image_data_uri(constat.photo)" style="max-width: 160px;"/>
                                    </td>
                                <td><span t-field="constat.state"/></td>
                                <td><span t-field="constat.date"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>
    </template>
    <template id="report_prestation">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="br_consult.report_prestation_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>
    
    <record id="action_report_prestation" model="ir.actions.report">
            <field name="name">Rapport prestation</field>
            <field name="model">prestation.prestation</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">br_consult.report_prestation</field>
            <field name="report_file">br_consult.report_prestation</field>
            <field name="print_report_name">'Prestation - %s' % (object.name)</field>
            <field name="binding_model_id" ref="model_prestation_prestation"/>
            <field name="binding_type">report</field>
        </record>

</odoo>