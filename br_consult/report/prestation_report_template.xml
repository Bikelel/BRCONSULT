<?xml version="1.0" encoding="utf-8"?>

<odoo>
    <template id="report_prestation_document">
        <t t-call="web.external_layout">
            <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)" />
            <!--   HEADER           -->
            <div>
                <t t-set="report_name_brconsult" t-value='doc.name'/>
                <t t-set="partner_id_name_brconsult" t-value='doc.partner_id.name' t-if='doc.partner_id'/>
                <t t-set="site_address_brconsult" t-value='doc.site_address' t-if='doc.site_address'/>
                <div class='row'>
                    <div class='col-2'>
                        <img t-if="doc.company_id.logo" t-att-src="image_data_uri(doc.company_id.logo)" style="max-height: 100px;"/>
                    </div>
                    <div class='col-10 text-center' style="border-radius:10px;border: 1px solid black;">
                        <div style="color:#5F5F5F;font-weight:bold;font-size:16px;"> <span>RAPPORT D’INSPECTION</span></div>
                        <div style="color:#C00000;font-weight:bold;font-size:20px;"><span t-esc="doc.title_label"/></div>
                        <div style="color:#5F5F5F;font-weight:bold;font-size:16px;">
                            <span>Type de mission :</span>
                            <span t-field="doc.verification_type" />
                        </div>
                        <div>
                            <span t-field="doc.message_label" style="color:#5F5F5F;font-weight:bold; font-size:12px;"/>
                        </div>
                    </div>
                </div>
            </div>
            <!--   Body   -->
            <div style="margin-top: 20px; font-size:12px;">
                <div class="row" style="font-size:11px;">
                    <div class='col-9'>
                        <t t-if="doc.name">
                            <span> N° Rapport: </span>
                            <span t-field="doc.name"/>
                        </t>
                    </div>
                    <div class='col-3' style="margin-left:40px;">
                        <t t-if="doc.date">
                            <span> Fait à </span>
                            <span t-field="doc.company_id.city" />, <br/>
                            Le <span t-field="doc.date"/>
                        </t>
                    </div>
                </div>
                <div name="table_fiche" style="margin-top:20px;">
                    <table class="table" style="border: 1px solid black;">
                        <tr style="border: 1px solid black;">
                            <td style="width: 50%; border: 1px solid black;">
                                Entreprise : <span t-field="doc.partner_id"/>
                            </td>
                            <td style="width: 50%; border: 1px solid black;">
                                Date et heure de vérification : <span t-field="doc.verification_date"/>
                            </td>
                        </tr>
                        <tr style="border: 1px solid black;">
                            <td style="width: 50%; border: 1px solid black;">
                                Représenté par : <span t-field="doc.partner_contact"/>
                            </td>
                            <td style="width: 50%; border: 1px solid black;">
                                Vérificateur : <span t-field="doc.user_id"/>
                            </td>
                        </tr>
                        <tr style="border: 1px solid black;">
                            <td style="width: 50%; border: 1px solid black;">
                                Adresse du chantier : <span t-field="doc.site_address"/><br/>
                                Localisation : <span t-field="doc.site_localisation"/>
                            </td>
                            <td style="width: 50%; border: 1px solid black;">
                                Nom de la personne présente lors de notre intervention : <span t-field="doc.prensent_contact"/><br/>
                                Surface d’échafaudage annoncée (en m²) : <span t-field="doc.scaffolding_surface"/><br/>
                                Surface d’échafaudage inspectée (en m²) = <span t-field="doc.inspected_scaffolding_surface"/>

                            </td>
                        </tr>
                    </table>
                </div>
                <div name="conformite_installation" class="text-center" style="margin-top:30px;">
                    <div style="font-weight:bold;font-size:16px;">CONFORMITE DE L’INSTALLATION</div>
                    <div style="font-size:11px;">
                        Rapport valable 3 mois. Au-delà, prévoir une vérification périodique (Article 6, Arrêté du 21/12/2004).<br/>
Prévoir une vérification de remise en service, dans les cas cités par l’article 4 de l’arrêté du 21/12/2004.<br/>
La vérification journalière est à la charge du chef d’entreprise (Article 5, Arrêté du 21/12/2004).

                    </div>
                </div>
                <div name="opinion" style="margin-top:30px;border: 1px solid black; padding:30px" class="row">
                    
                    <div class="col-6">
                        <div>
                            <input type="checkbox" t-att-checked="'checked' if doc.favorable_opinion else None"/> AVIS FAVORABLE
                        </div>
                        <div style="margin-top:10px;">
                            <input type="checkbox" t-att-checked="'checked' if doc.opinion_with_observation else None"/> Avec observation(s)
                            <t t-if="doc.defavorable_opinion">
                            <br/>
                            Levée d’observations recommandée
                        </t>
                        </div>
                    </div>
                    <div class="col-6">
                        <input type="checkbox" t-att-checked="'checked' if doc.defavorable_opinion else None"/> AVIS DEFAVORABLE
                        <t t-if="doc.defavorable_opinion">
                            <br/>
                            Levée de réserves recommandée)
                        </t>
                        
                    </div>
                </div>
                <div name="visa" style="margin-top:30px;">
                    <table class='table'>
                        <tr>
                            <td style="width: 60%; border: 1px solid black;">
                                Commentaires:<br/>
                                <span t-field="doc.comment_observation_fiche"/>
                            </td>
                            <td style="width: 40%; border: 1px solid black;" class='text-center'>
                                Visa de <span t-field='doc.user_id'/><br/>
                                <img t-if="doc.user_id.visa_user" t-att-src="image_data_uri(doc.user_id.visa_user)" style="max-height: 80px;"/>
                                <br/>
                                BR CONSULT
                            </td>
                        </tr>
                    </table>
                </div>
                <div style="page-break-after: always;"/>
                <div style="border-radius:10px;border: 1px solid black; margin-top:30px; padding:15px">
                    1) Périmètre de la mission
                </div>
                <div style="margin-top:30px;">
La présente mission est réalisée conformément au contrat référencé A17 (dans sa dernière version)
 Il s’agit d’une mission de MISE EN SERVICE (automatiquement) limitée à la vérification visuelle des zones de l’échafaudage accessibles en sécurité. <br/>

L’examen d’adéquation repose sur les informations écrites, transmises par le client. <br/>

Elle s’achève avec la remise du présent rapport.<br/>
-	Les observations listent les non-conformités anomalies constatées par l’inspecteur, <br/>
-	Les réserves listent les anomalies bloquantes (en gras dans le texte) qui motivent l’avis défavorable.<br/>
-	Les commentaires précisent les conditions de l’inspection. <br/>

En cas d’avis favorable avec observation(s), il est conseillé recommandé au chef d’entreprise de veiller à la levée des observations. Cette levée pourra être communiquée par courriel à l’adresse suivante controlebr@brconsult.fr et sera annexée au dossier.<br/>
L’émission de tout nouveau rapport sera facturée.<br/>

En cas d’avis défavorable, il est conseillé recommandé au chef d’entreprise de faire lever les observations réserves avant toute utilisation et d’en faire constater la levée par une personne compétente de son choix. A ce titre une nouvelle demande d’intervention est à transmettre  à l’adresse suivante controlebr@brconsult.fr .<br/>
L’émission de tout nouveau rapport sera facturée. <br/>
BR CONSULT, pour constater la levée des Observations réserves ayant entrainées l’avis défavorable. Cependant, cette nouvelle demande ne rentre pas dans le périmètre de la présente mission.<br/>

Hors mission :  <br/>
- La vérification de la résistance des supports (essais d’arrachement , pression admissible par les sols) <br/>
- La vérification des couples de serrage ; <br/>
- L’émissions d’un avis sur les notes de calculs; <br/>
- La conformité de l’installation au code de la route. <br/>
- Les contrôles réglementaires des appareils de levage installés sur l’échafaudage; <br/>

                </div>
                <div style="border-radius:10px;border: 1px solid black; margin-top:30px; padding:15px">
                    2) Localisation, schéma et photographies de l’échafaudage
                </div>
                <div style="margin-top:30px;">
                    Schéma <br/>
                    <img t-if="doc.location_diagram" t-att-src="image_data_uri(doc.location_diagram)" style="max-height: 350px;"  class='text-center'/>
                </div>
                <div style="margin-top:30px;">
                    Photos <br/>
                    <div class='text-center'>
                        <t t-set="i" t-value="1" />
                        <t t-foreach="doc.image_ids" t-as="image">
                            
                            <div class='col-auto col-6' style="padding:15px;">
                                <p><img t-if="image.image" t-att-src="image_data_uri(image.image)" style="max-height: 350px;"/></p>
                                
                                <span t-esc="i"/> 
                               
                                
                            </div>
<!--                             <t t-set="i" t-value="i+1"/>
                            <t t-if="(i % 2) == 0">
                                <br/>
                            </t> -->
                        </t>
                    </div>
                </div>
                <div style="border-radius:10px;border: 1px solid black; margin-top:30px; padding:15px">
                    3) Caractéristiques de l’échafaudage
                </div>
                <table class='table' style="margin-top:30px;" border="1">
                    <thead>
                        <th>Marque</th>
                        <th>Type</th>
                        <th>Hauteur de 1er Niveau</th>
                        <th>Hauteur maxi (en m)</th>
                        <th>Linéaire (en m)</th>
                        <th>Surface inspectée (en m2)</th>
                    </thead>
                    <tbody>
                        <t t-foreach="doc.scaffolding_mark_ids" t-as="mark">
                            <tr>
                                <td><span t-field="mark.mark_id"/></td>
                                <td><span t-field="mark.type"/></td>
                                <td><span t-field="mark.height"/></td>
                                <td><span t-field="mark.height_max"/></td>
                                <td><span t-field="mark.linear"/></td>
                                <td><span t-field="mark.inspected_surface"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <table class='table' style="margin-top:30px;">
                    <thead>
                        <th>Caractéristiques</th>
                        <th>Présence</th>
                        <th>HLongueur</th>
                        <th>Largeur</th>
                        <th>Hauteur</th>
                        <th>Surface</th>
                        <th>Localisation </th>
                    </thead>
                    <tbody>
                        <t t-foreach="doc.scaffolding_characteristic_ids" t-as="charac">
                            <tr>
                                <td><span t-field="charac.characteristic_id"/></td>
                                <td><span t-field="charac.is_presence"/></td>
                                <td><span t-field="charac.length"/></td>
                                <td><span t-field="charac.width"/></td>
                                <td><span t-field="charac.height"/></td>
                                <td><span t-field="charac.surface"/></td>
                                <td><span t-field="charac.localisation_id"/></td>
                                
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div style="border: 1px solid black; padding:10px">
                    Commentaires:<br/>
                    <span t-field="doc.comment_scaffolding_characteristic"/>
                </div>
                <div style="border-radius:10px;border: 1px solid black; margin-top:30px; padding:15px">
                    4) Examens
                </div>
                <div style="font-size:14px; margin-top:20px;">
                    4.1) Examen d’adéquation
                </div>
                <div>
Art. 3 – I- « L’examen d’adéquation d’un échafaudage » consiste à vérifier que l’échafaudage est approprié aux travaux que l’utilisateur prévoit d’effectuer, ainsi qu’aux risques auxquels les travailleurs sont exposés, et que les opérations prévues sont compatibles avec les conditions d’utilisation de l’échafaudage définies par le fabricant »
(Arrêté du 21 Décembre 2004).
                </div>
                <div style="margin-top:20px;">
                   • Nature des travaux :
                </div>
                <table class='table' style="margin-top:20px;">
                    <thead>
                        <th>Marque</th>
                        <th>Type</th>
                        <th>Hauteur de 1er Niveau</th>
                    </thead>
                    <tbody>
                        <t t-foreach="doc.adequacy_exam_ids" t-as="exam">
                            <tr>
                                <td><span t-field="exam.works_nature_id"/></td>
                                <td><span t-field="exam.precision"/></td>
                                <td><span t-field="exam.is_examined"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div style="margin-top:20px;">
                   • Dispositif de protection :
                </div>
                <div>
                    Présence d’un pare-gravats: <span t-field="doc.is_pare_gravats"/>
                </div>
                <div>
                    Présence d’un autre dispositif: <span t-field="doc.is_other_device"/>
                </div>
                <div t-if="doc.is_other_device">
                    Autre dispositif: <span t-field="doc.is_pare_gravats"/>
                </div>
                <div style="margin-top:20px;">
                   • Charges d’exploitation de l’échafaudage par défaut:
                </div>
                <table class='table' style="margin-top:20px;">
                    <thead>
                        <th>Classe de l’échafaudage</th>
                        <th>Surcharge d’exploitation (en kg/m2)</th>
                    </thead>
                    <tbody>
                        <t t-foreach="doc.scaffolding_operating_load_ids" t-as="classe">
                            <tr>
                                <td><span t-field="classe.scaffolding_class_id"/></td>
                                <td><span t-field="classe.operating_overload"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div style="margin-top:20px;">
                   • Constat(s):
                </div>
                <table class='table' style="margin-top:20px;">
                    <thead>
                        <th>Points de vérification</th>
                        <th>Observations/Réserves </th>
                        <th>Précisions </th>
                        <th class="text-center">Photos </th>
                        <th>Statut </th>
                        <th>Date </th>
                    </thead>
                    <tbody>
                        <t t-foreach="doc.constat_adequacy_exam_ids" t-as="constat">
                            <tr>
                                <td ><span t-field="constat.verification_point_id"/></td>
                                <td><span t-field="constat.reserve"/></td>
                                <td><span t-field="constat.precision"/></td>
                                <td style="width: 40%;" class="text-center"><img t-if="constat.photo" t-att-src="image_data_uri(constat.photo)" style="max-width: 160px;"/>
                                    </td>
                                <td><span t-field="constat.state"/></td>
                                <td><span t-field="constat.date"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                
                <div style="font-size:14px; margin-top:20px;">
                    4.2) Examen de montage et d'installation
                </div>
                <div>
                Art. 3 – II- « L’examen de l’état de montage et d’installation d’un échafaudage » consiste à s’assurer qu’il est monté et installé de façon sûre, conformément à la notice d’instructions du fabricant ou, lorsque la configuration de montage ne correspond pas à un montage prévu dans la notice, en tenant compte de la note de calcul et conformément au plan de montage établi par une personne compétente »
(Arrêté du 21 Décembre 2004).
                </div>
                <div style="margin-top:20px;">
                    Présentation de registre de sécurité : <span t-field="doc.security_register"/>
                </div>
                <div style="margin-top:20px;">
                    Mise à disposition du dossier de montage : <span t-field="doc.assembly_file"/>
                </div>
                <table t-if="doc.assembly_file=='yes'" class="table">
                    <thead class="text-center">
                        
                        <th>Plans d’exécution (PE)</th>
                        <th>Note de calcul</th>
                    </thead>
                    <tbody>
                        <tbody>
                            <tr class="text-center">
                                
                                <td><input type="checkbox" t-att-checked="'checked' if doc.execution_plan else None"/></td>
                                <td><input type="checkbox" t-att-checked="'checked' if doc.calculation_notice else None"/></td>
                            </tr>
                        </tbody>
                    </tbody>
                </table>
                <div>
                    Mise à disposition du dossier de montage : <span t-field="doc.manufacturer_instructions"/>
                </div>
                <div>
                     Nature du sol/support d’implantation : 
                    <ul>
                        <t t-foreach="doc.soil_support_data_ids" t-as="soil">
                            <li><span t-field="soil.name"/></li>
                        </t>
                    </ul>
                </div>
                <div>
                    Nature des supports d’ancrage :
                    <ul class="list-inline">
                        <t t-foreach="doc.anchor_support_data_ids" t-as="anchor">
                            <li><span t-field="anchor.name"/></li>
                        </t>
                    </ul>
                </div>
                <div>
                    Données aux ancrages: 
                    <div>Type d'ancrage : <span t-field="doc.anchor_type_id"/></div>
                    <div t-if="doc.anchor_type_id and doc.anchor_type_id.id==1">Type de chevilles : <span t-field="doc.ankles_type"/></div>
                    <div>Nombre constaté : <span t-field="doc.anchor_data_number"/></div>
                    <div>Nombre théorique requis: <span t-field="doc.anchor_data_theoretical_number"/></div>
                    <div>Différence : <span t-field="doc.anchor_data_difference_number"/></div>
                </div>
                <div>Données relatives aux réactions d'appuis au sol ou au support d’accueil: <span t-field="doc.ground_support_data"/></div>
                <div>Données relatives aux charges climatiques: <span t-field="doc.climatic_data"/></div>
                <div>Données relatives à la nature du bâchage éventuel: <span t-field="doc.covering_nature_data"/></div>
                <div style="margin-top:20px;">
                   • Constat(s):
                </div>
                <table class='table' style="margin-top:20px;">
                    <thead>
                        <th>Points de vérification</th>
                        <th>Observations/Réserves </th>
                        <th>Précisions </th>
                        <th class="text-center">Photos </th>
                        <th>Statut </th>
                        <th>Date </th>
                    </thead>
                    <tbody>
                        <t t-foreach="doc.constat_assembly_exam_ids" t-as="constat">
                            <tr>
                                <td ><span t-field="constat.verification_point_id"/></td>
                                <td ><span t-field="constat.reserve"/></td>
                                <td><span t-field="constat.precision"/></td>
                                <td style="width: 40%;" class="text-center"><img t-if="constat.photo" t-att-src="image_data_uri(constat.photo)" style="max-width: 160px;"/>
                                    </td>
                                <td><span t-field="constat.state"/></td>
                                <td><span t-field="constat.date"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                <div style="margin-top:20px;">
                    Examen de l'etat de conservation:
                </div>
                <table class='table' style="margin-top:20px;">
                    <tr>
                        <td style="width: 80%;">La présence et la bonne installation des dispositifs de protection collective et des moyens d'accès</td>
                        <td><span t-field="doc.presence_correct_installation"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">L'absence de déformation permanente ou de corrosion des éléments constitutifs de l'échafaudage pouvant compromettre sa solidité</td>
                        <td><span t-field="doc.permanent_deformation_absence"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">La présence de tous les éléments de fixation ou de liaison des constituants de l'échafaudage</td>
                        <td><span t-field="doc.presence_fixing"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">L'absence de jeu décelable susceptible d'affecter ces éléments</td>
                        <td><span t-field="doc.absence_detectable_play"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">La bonne tenue des éléments d'amarrage (ancrage, vérinage)</td>
                        <td><span t-field="doc.good_behavior"/></td>
                    </tr>
                     <tr>
                        <td style="width: 80%;">L'absence de désordre au niveau des appuis et des surfaces portantes</td>
                        <td><span t-field="doc.absence_disorder"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">La présence de tous les éléments de calage et de stabilisation ou d'immobilisation</td>
                        <td><span t-field="doc.presence_wedging"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">La bonne fixation des filets et des bâches sur l'échafaudage, ainsi que la continuité du bâchage sur toute la surface extérieure</td>
                        <td><span t-field="doc.good_fixing"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">Le maintien de la continuité, de la planéité, de l'horizontalité et de la bonne tenue de chaque niveau de plancher</td>
                        <td><span t-field="doc.maintaining_continuity"/></td>
                    </tr>
                     <tr>
                        <td style="width: 80%;">La visibilité des indications sur l'échafaudage relatives aux charges admissibles</td>
                        <td><span t-field="doc.visibility_indications"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">L'absence de charges dépassant ces limites admissibles</td>
                        <td><span t-field="doc.absence_loads_exceeding"/></td>
                    </tr>
                    <tr>
                        <td style="width: 80%;">L'absence d'encombrement des planchers</td>
                        <td><span t-field="doc.lack_floor_space"/></td>
                    </tr>
                </table>
                <div style="margin-top:20px;">
                   • Constat(s):
                </div>
                <table class='table' style="margin-top:20px;">
                    <thead>
                        <th>Points de vérification</th>
                        <th>Observations/Réserves </th>
                        <th>Précisions </th>
                        <th class="text-center">Photos </th>
                        <th>Statut </th>
                        <th>Date </th>
                    </thead>
                    <tbody>
                        <t t-foreach="doc.constat_conservation_state_exam_ids" t-as="constat">
                            <tr>
                                <td ><span t-field="constat.verification_point_id"/></td>
                                <td><span t-field="constat.reserve"/></td>
                                <td><span t-field="constat.precision"/></td>
                                <td style="width: 40%;" class="text-center"><img t-if="constat.photo" t-att-src="image_data_uri(constat.photo)" style="max-width: 160px;"/>
                                    </td>
                                <td><span t-field="constat.state"/></td>
                                <td><span t-field="constat.date"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>
    </template>
    <template id="report_prestation">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="br_consult.report_prestation_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>
    
    <record id="action_report_prestation" model="ir.actions.report">
            <field name="name">Rapport prestation</field>
            <field name="model">prestation.prestation</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">br_consult.report_prestation</field>
            <field name="report_file">br_consult.report_prestation</field>
            <field name="print_report_name">'Prestation - %s' % (object.name)</field>
            <field name="binding_model_id" ref="model_prestation_prestation"/>
            <field name="binding_type">report</field>
        </record>

</odoo>